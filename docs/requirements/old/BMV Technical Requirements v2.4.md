# ТЕХНИЧЕСКАЯ СПЕЦИФИКАЦИЯ (TRS)

**Проект:** BMV Eco System Market Making Bot
**Версия:** 2.4 (Consolidated & Customer Feedback 08.01)
**Дата:** 08.01.2026

---

## CHANGELOG

### v2.2.1 → v2.4
Этот релиз восстанавливает структуру и полноту спецификации, а также учитывает новые требования, полученные 8 января 2026 года:

- **Pivot Point:** вернулся режим чистого VWAP – в расчёт средней цены не включаются комиссии и прочие расходы. Все затраты учётных операций фиксируются в собственной базе данных и со временем покрываются спредом.
- **Собственные записи:** для расчёта Pivot и анализа торговли используется локальная история сделок (PostgreSQL), чтобы не обращаться каждый раз к блокчейну.
- **Лимиты ордеров:** вместо жёстких 16 BUY / 16 SELL на кошелёк, применяется общий лимит 32 лимитных ордеров на канал (BUY + SELL) для каждого кошелька; количество уровней на канале растёт вместе с числом кошельков. Ширина зон BUY и SELL изменяется инерционно вместе с рынком; отношение 30 % / 15 % – лишь настройка по умолчанию.
- **Rebalance Trigger:** перестройка сетки выполняется при отклонении текущей цены от центра канала более чем на заданный порог (по умолчанию 1 %); это позволяет снизить нагрузку на биржу и уменьшить риск проскальзывания. Каждая сделка больше не вызывает полный rebuild, но существует тайм‑аут принудительной синхронизации (например, 1 час).
- **Fiat Manager:** концепция «Fiat Floor» заменена на динамический буфер ликвидности – бот регулирует долю SOL и USDC на верхней и нижней границах канала. В верхней части часть SOL постепенно конвертируется в USDC, а в нижней – USDC возвращается в SOL. Отношения 100/0 → 70/30 по умолчанию являются только ориентиром и регулируются в параметрах.
- **Target Control:** целевой процент контроля эмиссии (раньше 51 %) больше не жёсткая константа. Он вычисляется динамически: суммарная эмиссия минус заблокированные монеты минус токены на собственных кошельках и в открытых ордерах. При росте объёма монет у сторонних держателей бот увеличивает плотность BUY‑зоны.
- **Flash Volume / Atomic Wash Trading:** для создания визуальной активности введён механизм атомарных встречных сделок. Два кошелька из пула совершают покупку и продажу одного и того же объёма SOL (по умолчанию 0.1 SOL) в одном Jito Bundle с минимальными чаевыми. Цена остаётся неизменной, а убыток равен только комиссии сети. Этот модуль заменяет прежний Market Noise и настраивается через параметры.

*Дополнительно сохранены улучшения из предыдущих версий: Seeded Pivot, горизонтальное масштабирование Swarm, расширенные метрики наблюдаемости и безопасность.*

### v2.1 → v2.2
Краткий список изменений между версиями 2.1 и 2.2 приведён для справки:
- введён режим FULL COST BASIS для Pivot;
- ребалансировка сделана event‑driven (каждый Fill);
- контроль эмиссии вынесен в конфигурацию;
- фиксирована аксиома 32 ордера (16 BUY + 16 SELL) на кошелёк;
- улучшены разделы Observability и Swarm.

### v2.2 → v2.2.1
Основное новшество 2.2.1 – модуль Market Noise: при отсутствии активности бот выставляет чередующиеся рыночные ордера (buy/sell) через Jito Bundles. Кроме того, был добавлен Seeded Pivot (инициализация истинной средней с весом в 365 дней) и новые параметры `NOISE_ENABLED`, `NOISE_MODE`, `NOISE_ORDER_USD`, `NOISE_IDLE_INTERVAL_MIN`.

---

## 1. ВВЕДЕНИЕ И ЦЕЛИ

Система предназначена для автоматизированного маркет‑мейкинга на блокчейне Solana и выполняет роль Growth Engine, а не арбитражного бота.

**Цели:**
1. **Стабилизация цены:** поддержание цены токена BMV в восходящем канале и подавление резких просадок.
2. **Асимметрия ликвидности:** создание плотной BUY‑зоны и разреженной SELL‑зоны, позволяющих цене расти свободнее.
3. **Защита фиатной стоимости:** хранение части активов в USDC для демпфирования падений курса SOL.
4. **Скрытность и MEV‑защита:** использование роя кошельков и Jito Bundles для предотвращения фронт‑раннинга и защиты стратегии.
5. **Аккумуляция эмиссии:** выкуп свободной эмиссии для контроля ликвидности.

---

## 2. ТЕХНОЛОГИЧЕСКИЙ СТЕК

### 2.1 Core
- **Язык:** Python 3.11+ (строгая типизация).
- **Архитектура:** Asyncio, однопроцессная модель.
- **Клиенты Solana:** solana‑py, solders, anchorpy.

### 2.2 Инфраструктура
- **RPC:** выделенный узел (Helius/QuickNode) с поддержкой WebSocket.
- **Execution Layer:** Jito Block Engine (gRPC/HTTP) – обязательный шлюз для всех транзакций, включая рыночный шум и flash volume.
- **Хранилища:**
    - **Redis (hot state):** текущий снэпшот ордербука и балансы;
    - **PostgreSQL/SQLite (cold state):** история сделок, расчёт VWAP, хранение собственных записей для Pivot.
- **Логирование:** structlog в JSON формате.
- **Метрики:** Prometheus; TUI (rich) или Grafana для визуализации.

---

## 3. МАТЕМАТИЧЕСКОЕ ЯДРО

### 3.1 Pivot Point — чистый VWAP (DEFAULT)
Для определения центра канала используется средневзвешенная цена по объёму (VWAP). Операционные издержки (комиссии, чаевые, rent) не входят в формулу и компенсируются спредом. Расчёт ведётся на основе накопленной истории сделок из локальной базы данных:

$$Pivot = \frac{\sum (price \times volume)}{\sum volume}$$

- **Историческое окно:** скользящие 365 дней.
- **Seeded Pivot:** При запуске, когда история BMV мала, текущая истинная средняя вычисляется и получает вес, эквивалентный 365 дням. Далее семенные данные постепенно вытесняются новыми.
- **Linear Fade‑in:** Возможен режим плавного перехода от SOL/USD (включается конфигурацией).

### 3.2 Геометрия асимметричного канала
Канал состоит из двух зон относительно Pivot:

#### BUY Zone (Поддержка)
- **Ширина:** по умолчанию – 15 % вниз от Pivot. Параметр настраивается, а границы изменяются инерционно с рынком.
- **Плотность:** высокая (экспоненциальная): чем ближе к нижней границе, тем крупнее объёмы.
- **Масштабирование:** зависит от `TARGET_CONTROL_%` – чем выше желаемый контроль эмиссии, тем плотнее BUY‑стена.

#### SELL Zone (Рост)
- **Ширина:** по умолчанию – 30 % вверх от Pivot. Параметр регулируется.
- **Плотность:** низкая (разреженная), чтобы цена могла расти при минимальном сопротивлении.

*Примечание: Изначальные значения 30 %/15 % – настройки по умолчанию и могут быть изменены без изменения логики.*

---

## 4. АРХИТЕКТУРА ИСПОЛНЕНИЯ

### 4.1 Swarm Orchestrator
Для обхода ограничения OpenBook на количество открытых ордеров используется система мульти‑кошельков:
- **Лимит ордеров:** один кошелёк может держать до 32 лимитных ордеров (BUY + SELL). Деление 16 BUY / 16 SELL является условным; фактическое распределение зависит от ширины BUY/SELL‑зон и общего числа уровней.
- **Глобальная сетка:** количество уровней в канале (например, 100) распределяется между кошельками. Каждый кошелёк обслуживает свой сегмент из 32 ордеров.
- **Ротация:** Worker‑кошельки действуют параллельно, создавая единый стакан. Балансы и истории синхронизируются через общий Redis и базу.

### 4.2 Rebalancing Logic (Threshold Driven)
Полный ребилд сетки выполняется, если:
1. Отклонение текущей цены от Pivot превышает `REBALANCE_THRESHOLD_%` (по умолчанию 1 %);
2. Или проходит принудительный интервал синхронизации (например, 1 час);
3. Или бот получает внешний сигнал (Kill Switch, изменение конфигурации).

Этот подход снижает нагрузку по сравнению с event‑driven ребалансировкой. Для дополнительной защиты от снайперов бот сканирует L2‑стакан и размещает ордер на 1 тик (0.000001 SOL) выгоднее крупного конкурирующего ордера.

### 4.3 Flash Volume & Market Noise
**Flash Volume (Atomic Wash Trading)** используется для генерации видимого объёма при отсутствии сделок:
1. Бот выбирает два различных кошелька из пула.
2. Кошелёк A покупает заданный объём (по умолчанию 0.1 SOL), кошелёк B одновременно продаёт тот же объём.
3. Обе инструкции упаковываются в один **Jito Bundle** с минимальными чаевыми (например, 0.001 SOL) и исполняются атомарно.
4. На графике появляется пара сделок Buy/Sell, цена не меняется, а потери ограничены сетевой комиссией.

**Настройки:**
- `FLASH_VOLUME_ENABLED` — включение режима.
- `FLASH_VOLUME_SIZE_SOL` — объём встречной сделки (default 0.1 SOL).
- `FLASH_VOLUME_INTERVAL_MIN` — минимальный интервал между атомарными сделками (по умолчанию 15 минут).
- `FLASH_VOLUME_TIP_SOL` — чаевые для валидатора (default 0.001 SOL).

Модуль Flash Volume является развитием идеи Market Noise. Чередующиеся рыночные ордера из версии 2.2.1 по‑прежнему могут использоваться (режим `NOISE_MODE = alternated_market_cross`) — бот выставляет противоположные рыночные ордера объёмом `NOISE_ORDER_USD` через Jito Bundles, если в течение `NOISE_IDLE_INTERVAL_MIN` минут не было активностей.

---

## 5. ФИНАНСОВЫЙ МЕНЕДЖМЕНТ

### 5.1 Ликвидность и Fiat Buffer
**Динамический буфер USDC/SOL.** Вместо жёсткой концепции «Fiat Floor» используется градиентное распределение активов:
- **В верхней части канала (SELL‑зона):** часть полученных от продаж SOL постепенно конвертируется в USDC. Соотношение SOL/USDC изменяется от 100/0 у Pivot до 70/30 у верхней границы по умолчанию.
- **В нижней части (BUY‑зона):** накопленные USDC тратятся на покупку SOL, восстанавливая BUY‑сетку и поддерживая цену токена. Соотношение BMV/USDC меняется аналогично от 100/0 до 70/30.

*Пороговые значения (70 %, 30 %) являются настройками и могут быть скорректированы.*

**Авто‑инъекция:** если доля SOL в общем резерве падает ниже `MIN_SOL_RESERVE_%`, бот автоматически закупает SOL за USDC (через Jupiter) и распределяет их по торговым кошелькам.

### 5.2 Target Control
Целевой процент контроля эмиссии `TARGET_CONTROL_%` рассчитывается динамически:

$$TARGET\_CONTROL\_\% = 100\% - LockedTokens - OwnedTokens$$

Где `OwnedTokens` включает токены на кошельках бота и в выставленных лимитных ордерах. При увеличении объёма токенов у сторонних держателей бот повышает плотность BUY‑зоны для выкупа эмиссии обратно и поддержания контроля.

### 5.3 Rent Recovery
Закрытые аккаунты OpenBook освобождают залоговую ренту (≈ 0.023 SOL). Периодический процесс (`RENT_RECOVERY_TIME`) сканирует закрытые ордера и вызывает инструкцию `CloseAccount` для возврата ренты.

---

## 6. КОНФИГУРАЦИЯ (Hot‑Reload)

Параметры управляются из конфигурационного файла или переменных окружения и могут изменяться без перезапуска бота.

| Параметр | Default | Описание |
| :--- | :--- | :--- |
| `HISTORY_WINDOW_DAYS` | 365 | Длина окна для VWAP |
| `BUY_CHANNEL_WIDTH_%` | 15 | Ширина BUY‑зоны |
| `SELL_CHANNEL_WIDTH_%` | 30 | Ширина SELL‑зоны |
| `REBALANCE_THRESHOLD_%` | 1 | Порог отклонения цены для перестройки |
| `ORDERS_PER_WALLET` | 32 | Максимум лимитных ордеров на кошелёк |
| `TARGET_CONTROL_%` | Dynamic | Целевой контроль эмиссии |
| `UPPER_USDC_RATIO_MAX_%` | 30 | Доля USDC у верхней границы канала |
| `LOWER_USDC_RATIO_MAX_%` | 30 | Доля USDC у нижней границы канала |
| `MIN_SOL_RESERVE_%` | 70 | Порог, при котором активируется USDC‑→‑SOL инъекция |
| `JITO_TIP_AMOUNT_SOL` | 0.005 | Чаевые валидатору для лимитных транзакций |
| `RENT_RECOVERY_TIME` | 1h | Интервал возврата ренты |
| `FLASH_VOLUME_ENABLED` | true | Включение атомарных встречных сделок |
| `FLASH_VOLUME_SIZE_SOL` | 0.1 | Объём каждой стороны Flash Volume |
| `FLASH_VOLUME_INTERVAL_MIN` | 15 | Интервал между Flash Volume |
| `FLASH_VOLUME_TIP_SOL` | 0.001 | Чаевые для валидатора в Flash Volume |
| `NOISE_MODE` | alternated_market_cross | Режим рыночного шума (устаревший) |
| `NOISE_ORDER_USD` | 10 | Размер рыночной сделки в режиме Noise |
| `NOISE_IDLE_INTERVAL_MIN` | 15 | Пауза без активности для запуска Noise |

---

## 7. БЕЗОПАСНОСТЬ

1. **Kill Switch:** глобальная переменная в Redis/Memory. При активации бот отменяет все ордера и завершает процессы.
2. **MEV Protection:** все write‑транзакции отправляются в Jito Block Engine; публичный мемпул не используется; Atomic Bundles защищают от sandwich‑атак.
3. **Exposure Limits:** жёсткое ограничение максимального размера ордера (в процентах от баланса кошелька), чтобы исключить ошибки округления и чрезмерный риск.
4. **Key Management:** приватные ключи загружаются из зашифрованного .env или внешнего Vault; ключи никогда не хранятся в коде.

---

## 8. OBSERVABILITY & MARKET PRESENCE

Бот генерирует структурированные события и метрики для мониторинга и анализа стратегии.

**Обязательные события:**
- `GRID_REBUILD` `{ pivot, trigger, wallet }`
- `ORDER_FILL` `{ price, volume }`
- `FIAT_INJECTION` `{ usdc, sol }`
- `RENT_RECLAIM` `{ sol }`
- `FLASH_VOLUME` `{ side, volume, tip }`

*Для устаревшего режима Noise также используется:*
- `NOISE_TRADE` `{ side, notional_usd, reason }`

Эти события служат источником для внешнего мониторинга (Prometheus/Grafana) и публикации на витринах (например, DEXScreener).

**Дополнительные метрики:**
- **Synthetic Volume Rate** – доля искусственного объёма (Flash Volume / Noise) относительно общего оборота.
- **Trade Cadence** – среднее время между сделками.
- **Market Noise Ratio** – отношение шумовых сделок к реальным.
- **Wallet Exposure** – распределение активов и рисков по кошелькам.

---

## 9. ПОВЕДЕНЧЕСКИЕ СЦЕНАРИИ

1. **Рост SOL:** при росте цены SOL Pivot и SELL‑зона смещаются вверх, BUY‑зона подтягивается вслед; отношение SOL/USDC движется в сторону SOL.
2. **Падение SOL:** при падении курса активируется демпфер USDC; бот конвертирует USDC в SOL и усиливает BUY‑стену; Target Control увеличивает плотность заявок.
3. **Флэт:** если рынок стабилен, бот может периодически создавать микро‑сделки (Flash Volume или Noise) для поддержания видимости активности; зоны BUY/SELL остаются статичными до превышения порога перерасчёта.

---

**Статус документа:** CUSTOMER‑ALIGNED / IMPLEMENTATION READY
