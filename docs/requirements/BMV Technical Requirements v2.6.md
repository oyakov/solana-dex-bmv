ТЕХНИЧЕСКАЯ СПЕЦИФИКАЦИЯ (TRS)
Проект: BMV Eco System Market Making Bot
Версия: 2.6
Дата: 09.01.2026

CHANGELOG
v2.5 → v2.6
Данный релиз приводит документ в соответствие со структурной диаграммой системы и вводит явные описания модульных взаимодействий:

**Модульная архитектура**: явно определены модули Core Engine, Rebalancer, Financial Manager, Flash Volume Module, Market Noise Module, Rent Recovery Service.

**Price Oracle**: добавлено описание взаимодействия Core Engine с внешним оракулом SOL/USD для получения кросс-курса.

**Rebalancer**: описан как отдельный модуль с двумя ключевыми взаимодействиями — сканирование L2-стакана через Solana RPC и отправка сигнала rebuild trigger в Core Engine.

**Financial Manager**: выделен как модуль, отвечающий за конверсии SOL/USDC через Jupiter DEX.

**Jito Block Engine**: уточнено, что Rent Recovery Service, Flash Volume Module и Market Noise Module отправляют транзакции через Jito.

**Swarm Orchestrator**: добавлено явное описание взаимодействия с Redis и PostgreSQL.

**Observability**: описана связь Core Engine → Prometheus → Grafana.

v2.4 → v2.5
Этот релиз восстанавливает структуру и полноту спецификации, а также учитывает новые требования, полученные 8 января 2026 года:
Pivot Point: вернулся режим чистого VWAP – в расчёт средней цены не включаются комиссии и прочие расходы. Все затраты учётных операций фиксируются в собственной базе данных и со временем покрываются спредом.

Собственные записи: для расчёта Pivot и анализа торговли используется локальная история сделок (PostgreSQL), чтобы не обращаться каждый раз к блокчейну.

Лимиты ордеров: вместо жёстких 16 BUY / 16 SELL на кошелёк, применяется общий лимит 32 лимитных ордеров на канал (BUY + SELL) для каждого кошелька; количество уровней на канале растёт вместе с числом кошельков. Ширина зон BUY и SELL изменяется инерционно вместе с рынком; отношение 30 % / 15 % – лишь настройка по умолчанию.

Rebalance Trigger: перестройка сетки выполняется при отклонении текущей цены от центра канала более чем на заданный порог (по умолчанию 1 %); это позволяет снизить нагрузку на биржу и уменьшить риск проскальзывания. Каждая сделка больше не вызывает полный rebuild, но существует тайм‑аут принудительной синхронизации (например, 1 час).

Fiat Manager: концепция «Fiat Floor» заменена на динамический буфер ликвидности – бот регулирует долю SOL и USDC на верхней и нижней границах канала. В верхней части часть SOL постепенно конвертируется в USDC, а в нижней – USDC возвращается в SOL. Отношения 100/0 → 70/30 по умолчанию являются только ориентиром и регулируются в параметрах.

Target Control: целевой процент контроля эмиссии (раньше 51 %) больше не жёсткая константа. Он вычисляется динамически: суммарная эмиссия минус заблокированные монеты минус токены на собственных кошельках и в открытых ордерах. При росте объёма монет у сторонних держателей бот увеличивает плотность BUY‑зоны.

Flash Volume / Atomic Wash Trading: для создания визуальной активности введён механизм атомарных встречных сделок. Два кошелька из пула совершают покупку и продажу одного и того же объёма SOL (по умолчанию 0.1 SOL) в одном Jito Bundle с минимальными чаевыми. Цена остаётся неизменной, а убыток равен только комиссии сети. Этот модуль заменяет прежний Market Noise и настраивается через параметры.

Дополнительно сохранены улучшения из предыдущих версий: Seeded Pivot, горизонтальное масштабирование Swarm, расширенные метрики наблюдаемости и безопасность.

---

# 1. ВВЕДЕНИЕ И ЦЕЛИ
Система предназначена для автоматизированного маркет‑мейкинга на блокчейне Solana и выполняет роль Growth Engine, а не арбитражного бота.

## Токен BMV
Проект BMV реализован на блокчейне Solana. Ниже представлены ключевые идентификаторы и ссылки, используемые для взаимодействия с токеном и рынком:
- **Название токена**: BMV Eco System
- **Адрес (Mint Address)**: `8VMi93EEqSGCHGjRGNhEFBkGoNZTQxUFfFYWDEX2e5Uf`
- **Идентификатор рынка OpenBook**: `B9coHrCxYv7xmPfSU7Z5VfugDqdTdZqZTpBGBdazq8AC`
- **Торговая пара**: BMV / SOL (с кросс-курсом к USD/EUR)
- **Solscan**: Страница токена BMV Eco System

## Перечень используемых данных
Для функционирования бота используются следующие источники данных:

**On-chain (Блокчейн):**
- Market ID (OpenBook): `B9coHrCxYv7xmPfSU7Z5VfugDqdTdZqZTpBGBdazq8AC` — основная база для работы с ордербуком.
- Mint Address: `8VMi93EEqSGCHGjRGNhEFBkGoNZTQxUFfFYWDEX2e5Uf`.
- RPC URL: выделенный канал связи (Helius/QuickNode).

**Off-chain (Внешние):**
- Кросс-курс SOL/USD — для расчета фиатного эквивалента и защиты ценового "пола".

**История и Балансы (Локальная БД):**
- Суммарный баланс токенов на всех подконтрольных кошельках.
- Собственная история сделок бота и рынка (записывается в локальную базу данных).

## Цели
1. **Стабилизация цены**: поддержание цены токена BMV в восходящем канале и подавление резких просадок.
2. **Асимметрия ликвидности**: создание плотной BUY‑зоны и разреженной SELL‑зоны, позволяющих цене расти свободнее.
3. **Защита фиатной стоимости**: хранение части активов в USDC для демпфирования падений курса SOL.
4. **Скрытность и MEV‑защита**: использование роя кошельков и Jito Bundles для предотвращения фронт‑раннинга и защиты стратегии.
5. **Аккумуляция эмиссии**: выкуп свободной эмиссии для контроля ликвидности.

---

# 2. ТЕХНОЛОГИЧЕСКИЙ СТЕК

## 2.1 Core
- **Язык**: Python 3.11+ (строгая типизация).
- **Архитектура**: Asyncio, однопроцессная модель.
- **Клиенты Solana**: solana‑py, solders, anchorpy.

## 2.2 Инфраструктура

### Solana RPC
Выделенный узел (Helius/QuickNode) с поддержкой WebSocket. Используется для:
- Получения состояния блокчейна и балансов.
- Сканирования L2-стакана модулем Rebalancer.

### Jito Block Engine
Обязательный шлюз исполнения (gRPC/HTTP) для всех write-транзакций. Через Jito отправляются:
- Лимитные ордера от Core Engine.
- Атомарные wash-сделки от Flash Volume Module.
- Шумовые ордера от Market Noise Module.
- Инструкции CloseAccount от Rent Recovery Service.

### Price Oracle (SOL/USD)
Внешний источник кросс-курса SOL/USD. Core Engine периодически запрашивает актуальную цену для:
- Расчёта фиатного эквивалента позиций.
- Определения границ динамического буфера USDC.

### Хранилища
| Компонент   | Назначение                                                                 |
|-------------|---------------------------------------------------------------------------|
| **Redis**   | Hot state: текущий снэпшот ордербука, балансы, флаг Kill Switch.          |
| **PostgreSQL** | Cold state: история сделок, расчёт VWAP, хранение собственных записей. |

### Логирование и метрики
- **Логирование**: structlog в JSON формате.
- **Метрики**: Prometheus; Grafana для визуализации.

---

# 3. МАТЕМАТИЧЕСКОЕ ЯДРО

## 3.1 Pivot Point — чистый VWAP (DEFAULT)
Для определения центра канала используется средневзвешенная цена по объёму (VWAP). Операционные издержки (комиссии, чаевые, rent) не входят в формулу и компенсируются спредом. Расчёт ведётся на основе накопленной истории сделок из локальной базы данных:

```
Pivot = Σ(price × volume) / Σ volume
```

Историческое окно – скользящие 365 дней. При запуске, когда история BMV мала, используется Seeded Pivot: текущая истинная средняя вычисляется и получает вес, эквивалентный 365 дням. Далее семенные данные постепенно вытесняются новыми.

Возможен режим Linear Fade‑in от SOL/USD – включается конфигурацией и заменяет семенные данные историей SOL при плавном переходе.

## 3.2 Геометрия асимметричного канала
Канал состоит из двух зон относительно Pivot:

### BUY Zone (Поддержка)
- Ширина по умолчанию – 15 % вниз от Pivot. Параметр настраивается, а границы изменяются инерционно с рынком.
- Плотность ордеров высокая (экспоненциальная): чем ближе к нижней границе, тем крупнее объёмы.
- Масштабируется параметром TARGET_CONTROL_% – чем выше желаемый контроль эмиссии, тем плотнее BUY‑стена.

### SELL Zone (Рост)
- Ширина по умолчанию – 30 % вверх от Pivot. Параметр регулируется.
- Плотность низкая (разреженная), чтобы цена могла расти при минимальном сопротивлении.

Изначальные значения 30 %/15 % – настройки по умолчанию и могут быть изменены без изменения логики.

---

# 4. АРХИТЕКТУРА ИСПОЛНЕНИЯ

## 4.1 Модульная структура BMV Bot
Система состоит из следующих модулей:

| Модуль                  | Описание                                                                 |
|-------------------------|-------------------------------------------------------------------------|
| **Core Engine**         | Центральный движок: расчёт Pivot, построение сетки, отправка ордеров.   |
| **Swarm Orchestrator**  | Координация мульти-кошельков, распределение ордеров по сегментам.       |
| **Rebalancer**          | Мониторинг отклонения цены, инициация перестройки сетки.                |
| **Flash Volume Module** | Генерация атомарных wash-сделок для создания видимого объёма.           |
| **Market Noise Module** | Чередующиеся рыночные ордера для поддержания активности (устаревший).   |
| **Financial Manager**   | Управление балансом SOL/USDC, конверсии через Jupiter DEX.              |
| **Rent Recovery Service** | Возврат залоговой ренты с закрытых аккаунтов OpenBook.                |
| **Key Manager**         | Загрузка и безопасное хранение приватных ключей.                        |
| **Kill Switch**         | Экстренная остановка всех операций.                                     |

## 4.2 Swarm Orchestrator
Для обхода ограничения OpenBook на количество открытых ордеров используется система мульти‑кошельков:

- **Лимит ордеров**: один кошелёк может держать до 32 лимитных ордеров (BUY + SELL). Деление 16 BUY / 16 SELL является условным; фактическое распределение зависит от ширины BUY/SELL‑зон и общего числа уровней.
- **Глобальная сетка**: количество уровней в канале (например, 100) распределяется между кошельками. Каждый кошелёк обслуживает свой сегмент из 32 ордеров.
- **Ротация**: Worker‑кошельки действуют параллельно, создавая единый стакан. Балансы и истории синхронизируются через общий Redis и PostgreSQL.

### Взаимодействия Swarm Orchestrator
```
Swarm Orchestrator ↔ Redis      : координация состояния, распределение задач
Swarm Orchestrator ↔ PostgreSQL : синхронизация истории сделок
```

## 4.3 Rebalancer
Модуль Rebalancer отвечает за мониторинг рыночной цены и принятие решения о перестройке сетки.

### Взаимодействия Rebalancer
```
Rebalancer → Solana RPC   : L2 orderbook scan (сканирование стакана)
Rebalancer → Core Engine  : rebuild trigger (сигнал на перестройку сетки)
```

### Условия перестройки
Полный ребилд сетки выполняется, если:
1. Отклонение текущей цены от Pivot превышает `REBALANCE_THRESHOLD_%` (по умолчанию 1 %).
2. Проходит принудительный интервал синхронизации (например, 1 час).
3. Бот получает внешний сигнал (Kill Switch, изменение конфигурации).

Этот подход снижает нагрузку по сравнению с event‑driven ребалансировкой. Для дополнительной защиты от снайперов бот сканирует L2‑стакан и размещает ордер на 1 тик (0.000001 SOL) выгоднее крупного конкурирующего ордера.

## 4.4 Flash Volume Module
Модуль используется для генерации видимого объёма при отсутствии сделок (Atomic Wash Trading):

1. Бот выбирает два различных кошелька из пула.
2. Кошелёк A покупает заданный объём (по умолчанию 0.1 SOL), кошелёк B одновременно продаёт тот же объём.
3. Обе инструкции упаковываются в один Jito Bundle с минимальными чаевыми (например, 0.001 SOL) и исполняются атомарно.
4. На графике появляется пара сделок Buy/Sell, цена не меняется, а потери ограничены сетевой комиссией.

### Взаимодействия Flash Volume Module
```
Flash Volume Module → Jito Block Engine : atomic wash trades
```

### Настройки
| Параметр                   | Default | Описание                              |
|----------------------------|---------|---------------------------------------|
| `FLASH_VOLUME_ENABLED`     | true    | Включение режима                      |
| `FLASH_VOLUME_SIZE_SOL`    | 0.1     | Объём каждой стороны                  |
| `FLASH_VOLUME_INTERVAL_MIN`| 15      | Интервал между сделками (мин)         |
| `FLASH_VOLUME_TIP_SOL`     | 0.001   | Чаевые для валидатора                 |

## 4.5 Market Noise Module (Устаревший)
Чередующиеся рыночные ордера из версии 2.2.1 по‑прежнему могут использоваться — бот выставляет противоположные рыночные ордера объёмом `NOISE_ORDER_USD` через Jito Bundles, если в течение `NOISE_IDLE_INTERVAL_MIN` минут не было активностей.

### Взаимодействия Market Noise Module
```
Market Noise Module → Jito Block Engine : noise orders
```

---

# 5. ФИНАНСОВЫЙ МЕНЕДЖМЕНТ

## 5.1 Financial Manager
Модуль Financial Manager отвечает за управление балансом SOL/USDC и автоматические конверсии.

### Взаимодействия Financial Manager
```
Financial Manager → Jupiter DEX : conversions (SOL ↔ USDC)
```

### Ликвидность и Fiat Buffer
Динамический буфер USDC/SOL. Вместо жёсткой концепции «Fiat Floor» используется градиентное распределение активов:

- **В верхней части канала (SELL‑зона)**: часть полученных от продаж SOL постепенно конвертируется в USDC. Соотношение SOL/USDC изменяется от 100/0 у Pivot до 70/30 у верхней границы по умолчанию.
- **В нижней части (BUY‑зона)**: накопленные USDC тратятся на покупку SOL, восстанавливая BUY‑сетку и поддерживая цену токена. Соотношение BMV/USDC меняется аналогично от 100/0 до 70/30.
- Пороговые значения (70 %, 30 %) являются настройками и могут быть скорректированы.

### Авто‑инъекция
Если доля SOL в общем резерве падает ниже `MIN_SOL_RESERVE_%`, бот автоматически закупает SOL за USDC (через Jupiter DEX) и распределяет их по торговым кошелькам.

## 5.2 Target Control
Целевой процент контроля эмиссии `TARGET_CONTROL_%` рассчитывается динамически:

```
TARGET_CONTROL_% = 100% − LockedTokens − OwnedTokens
```

Где OwnedTokens включает токены на кошельках бота и в выставленных лимитных ордерах. При увеличении объёма токенов у сторонних держателей бот повышает плотность BUY‑зоны для выкупа эмиссии обратно и поддержания контроля.

## 5.3 Rent Recovery Service
Закрытые аккаунты OpenBook освобождают залоговую ренту (≈ 0.023 SOL). Периодический процесс (`RENT_RECOVERY_TIME`) сканирует закрытые ордера и вызывает инструкцию CloseAccount для возврата ренты.

### Взаимодействия Rent Recovery Service
```
Rent Recovery Service → Jito Block Engine : close accounts
```

---

# 6. КОНФИГУРАЦИЯ (Hot‑Reload)
Параметры управляются из конфигурационного файла или переменных окружения и могут изменяться без перезапуска бота. Стандартные значения:

| Параметр                   | Default                  | Описание                                      |
|----------------------------|--------------------------|-----------------------------------------------|
| `HISTORY_WINDOW_DAYS`      | 365                      | Длина окна для VWAP                           |
| `BUY_CHANNEL_WIDTH_%`      | 15                       | Ширина BUY‑зоны                               |
| `SELL_CHANNEL_WIDTH_%`     | 30                       | Ширина SELL‑зоны                              |
| `REBALANCE_THRESHOLD_%`    | 1                        | Порог отклонения цены для перестройки         |
| `ORDERS_PER_WALLET`        | 32                       | Максимум лимитных ордеров на кошелёк          |
| `TARGET_CONTROL_%`         | Dynamic                  | Целевой контроль эмиссии                      |
| `UPPER_USDC_RATIO_MAX_%`   | 30                       | Доля USDC у верхней границы канала            |
| `LOWER_USDC_RATIO_MAX_%`   | 30                       | Доля USDC у нижней границы канала             |
| `MIN_SOL_RESERVE_%`        | 70                       | Порог для USDC→SOL инъекции                   |
| `JITO_TIP_AMOUNT_SOL`      | 0.005                    | Чаевые валидатору для лимитных транзакций     |
| `RENT_RECOVERY_TIME`       | 1h                       | Интервал возврата ренты                       |
| `FLASH_VOLUME_ENABLED`     | true                     | Включение атомарных встречных сделок          |
| `FLASH_VOLUME_SIZE_SOL`    | 0.1                      | Объём каждой стороны Flash Volume             |
| `FLASH_VOLUME_INTERVAL_MIN`| 15                       | Интервал между Flash Volume                   |
| `FLASH_VOLUME_TIP_SOL`     | 0.001                    | Чаевые для валидатора в Flash Volume          |
| `NOISE_MODE`               | alternated_market_cross  | Режим рыночного шума (устаревший)             |
| `NOISE_ORDER_USD`          | 10                       | Размер рыночной сделки в режиме Noise         |
| `NOISE_IDLE_INTERVAL_MIN`  | 15                       | Пауза без активности для запуска Noise        |

---

# 7. БЕЗОПАСНОСТЬ

## Kill Switch
Глобальная переменная в Redis/Memory. При активации бот отменяет все ордера и завершает процессы.

### Взаимодействия Kill Switch
```
Kill Switch → Redis : stop operations
```

## MEV Protection
Все write‑транзакции отправляются в Jito Block Engine; публичный мемпул не используется; Atomic Bundles защищают от sandwich‑атак.

## Exposure Limits
Жёсткое ограничение максимального размера ордера (в процентах от баланса кошелька), чтобы исключить ошибки округления и чрезмерный риск.

## Key Manager
Приватные ключи загружаются из зашифрованного .env или внешнего Vault; ключи никогда не хранятся в коде.

---

# 8. OBSERVABILITY & MARKET PRESENCE
Бот генерирует структурированные события и метрики для мониторинга и анализа стратегии.

## Архитектура наблюдаемости
```
Core Engine → Prometheus : expose metrics
Prometheus ↔ Grafana    : визуализация и алертинг
```

## Обязательные события
```
GRID_REBUILD   { pivot, trigger, wallet }
ORDER_FILL     { price, volume }
FIAT_INJECTION { usdc, sol }
RENT_RECLAIM   { sol }
FLASH_VOLUME   { side, volume, tip }
```

Для устаревшего режима Noise также используется:
```
NOISE_TRADE    { side, notional_usd, reason }
```

Эти события служат источником для внешнего мониторинга (Prometheus/Grafana) и публикации на витринах (например, DEXScreener).

## Дополнительные метрики
- **Synthetic Volume Rate** – доля искусственного объёма (Flash Volume / Noise) относительно общего оборота.
- **Trade Cadence** – среднее время между сделками.
- **Market Noise Ratio** – отношение шумовых сделок к реальным.
- **Wallet Exposure** – распределение активов и рисков по кошелькам.

---

# 9. ПОВЕДЕНЧЕСКИЕ СЦЕНАРИИ

## Рост SOL
При росте цены SOL Pivot и SELL‑зона смещаются вверх, BUY‑зона подтягивается вслед; отношение SOL/USDC движется в сторону SOL.

## Падение SOL
При падении курса активируется демпфер USDC; бот конвертирует USDC в SOL и усиливает BUY‑стену; Target Control увеличивает плотность заявок.

## Флэт
Если рынок стабилен, бот может периодически создавать микро‑сделки (Flash Volume или Noise) для поддержания видимости активности; зоны BUY/SELL остаются статичными до превышения порога перерасчёта.

---

# 10. ДИАГРАММА ВЗАИМОДЕЙСТВИЙ

Ниже приведена сводная таблица всех ключевых взаимодействий между модулями системы:

| Источник                | Назначение          | Тип взаимодействия                     |
|-------------------------|---------------------|----------------------------------------|
| Core Engine             | Price Oracle        | fetch price (получение курса SOL/USD)  |
| Core Engine             | Prometheus          | expose metrics                         |
| Core Engine             | Storage (Redis/PG)  | read/write state                       |
| Core Engine             | Jito Block Engine   | trade execution                        |
| Swarm Orchestrator      | Storage (Redis/PG)  | coordination, sync                     |
| Rebalancer              | Solana RPC          | L2 orderbook scan                      |
| Rebalancer              | Core Engine         | rebuild trigger                        |
| Flash Volume Module     | Jito Block Engine   | atomic wash trades                     |
| Market Noise Module     | Jito Block Engine   | noise orders                           |
| Financial Manager       | Jupiter DEX         | conversions (SOL ↔ USDC)               |
| Rent Recovery Service   | Jito Block Engine   | close accounts                         |
| Kill Switch             | Redis               | stop operations                        |
| Jito Block Engine       | OpenBook DEX        | trade execution                        |
| Jito Block Engine       | Jupiter DEX         | trade execution                        |

---

**Статус документа**: CUSTOMER‑ALIGNED / IMPLEMENTATION READY
